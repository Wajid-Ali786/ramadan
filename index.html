<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramadan Quran Tracker Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme */
            --primary: #047857; /* Emerald 700 */
            --primary-light: #d1fae5;
            --primary-dark: #064e3b;
            --accent: #d97706; /* Amber 600 */
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-ar: 'Amiri', serif;
        }

        [data-theme="dark"] {
            --primary: #10b981; /* Emerald 500 */
            --primary-light: #064e3b;
            --primary-dark: #ecfdf5; /* Text on primary */
            --accent: #fbbf24;
            --bg: #0f172a; /* Slate 900 */
            --card-bg: #1e293b; /* Slate 800 */
            --text-main: #f3f4f6;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text-main);
            padding-bottom: 100px;
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior-y: none;
        }

        /* --- Header & Nav --- */
        .app-header {
            background: var(--card-bg);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo-area h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon { font-size: 1.5rem; }

        .header-actions { display: flex; gap: 10px; }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 40px; 
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
        }
        .icon-btn:hover { background: var(--bg); }
        .icon-btn:active { transform: scale(0.95); }

        /* --- Dashboard Stats --- */
        .dashboard {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card.full-width { grid-column: span 2; align-items: flex-start; text-align: left; flex-direction: row; justify-content: space-between; }

        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Circular Progress */
        .progress-ring { position: relative; width: 60px; height: 60px; }
        .progress-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring circle { fill: none; stroke-width: 5; }
        .bg-ring { stroke: var(--border); }
        .fill-ring { 
            stroke: var(--accent); 
            stroke-dasharray: 157; 
            stroke-dashoffset: 157; 
            transition: stroke-dashoffset 1s ease-out; 
            stroke-linecap: round;
        }
        .ring-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85rem; font-weight: 700; color: var(--text-main);
        }

        /* --- Para List --- */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .container { grid-template-columns: repeat(2, 1fr); }
            .dashboard { max-width: 800px; margin: 0 auto; }
        }

        .para-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .para-card:hover { transform: translateY(-2px); }
        .para-card:active { transform: scale(0.98); }

        .para-card.last-active { border: 2px solid var(--accent); }
        .last-active-badge {
            position: absolute; top: -8px; right: 10px;
            background: var(--accent); color: white;
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px;
            font-weight: bold;
        }

        .para-card.completed {
            background: var(--primary);
            border-color: var(--primary);
        }
        .para-card.completed * { color: white !important; }
        .para-card.completed .para-icon { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); }
        .para-card.completed .mini-bar { background: rgba(255,255,255,0.3); }
        .para-card.completed .mini-fill { background: #fff; }

        .para-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            background: var(--bg);
            color: var(--text-muted);
            font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .para-content { flex: 1; overflow: hidden; }
        .para-title { font-size: 1rem; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .para-arabic { font-family: var(--font-ar); color: var(--accent); font-size: 1.1rem; line-height: 1.2; }

        .para-meta { text-align: right; min-width: 60px; }
        .meta-text { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px; }
        
        .mini-bar { width: 100%; height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; }
        .mini-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; border-radius: 10px; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 100; opacity: 0; visibility: hidden; transition: 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-sheet {
            background: var(--card-bg);
            width: 100%; max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.active .modal-sheet { transform: translateY(0); }

        @media(min-width: 500px) {
            .modal-overlay { align-items: center; }
            .modal-sheet { border-radius: 24px; transform: translateY(20px) scale(0.95); }
            .modal-overlay.active .modal-sheet { transform: translateY(0) scale(1); }
        }

        .modal-header { text-align: center; margin-bottom: 20px; position: relative; }
        .handle-bar { width: 40px; height: 5px; background: var(--border); border-radius: 10px; margin: -10px auto 20px auto; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .modal-arabic { font-family: var(--font-ar); font-size: 1.4rem; color: var(--accent); margin-top: 4px; }

        /* Quick Actions */
        .quick-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-action {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-action:hover { background: var(--border); }

        /* Ruku Grid */
        .ruku-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 10px;
            overflow-y: auto;
            padding: 5px;
            margin-bottom: 20px;
            flex: 1;
        }

        .ruku-bubble {
            aspect-ratio: 1;
            border-radius: 14px;
            background: var(--bg);
            border: 2px solid transparent;
            color: var(--text-muted);
            font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
        }
        .ruku-bubble:hover { background: var(--border); }
        .ruku-bubble.checked {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }

        .btn-primary {
            width: 100%; padding: 16px;
            background: var(--primary); color: white;
            border: none; border-radius: 14px;
            font-size: 1rem; font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-primary:active { transform: scale(0.98); }

        /* Settings Modal */
        .settings-option {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .settings-option:last-child { border: none; }
        .settings-option h4 { font-size: 0.95rem; margin-bottom: 2px; }
        .settings-option p { font-size: 0.75rem; color: var(--text-muted); }

        /* Confetti Canvas */
        #confetti {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }
    </style>
</head>
<body>

    <canvas id="confetti"></canvas>

    <nav class="app-header">
        <div class="logo-area">
            <h1><span class="logo-icon">€û</span> Quran Tracker</h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                <span id="theme-icon">üåô</span>
            </button>
            <button class="icon-btn" onclick="openSettings()" title="Settings">
                <span>‚öôÔ∏è</span>
            </button>
        </div>
    </nav>

    <div class="dashboard">
        <div class="stat-card">
            <div class="stat-value" id="dash-paras">0</div>
            <div class="stat-label">Paras Completed</div>
        </div>
        <div class="stat-card">
            <div class="progress-ring">
                <svg>
                    <circle class="bg-ring" cx="30" cy="30" r="25"></circle>
                    <circle class="fill-ring" id="progress-circle" cx="30" cy="30" r="25"></circle>
                </svg>
                <div class="ring-text" id="dash-percent">0%</div>
            </div>
            <div class="stat-label">Total Progress</div>
        </div>
        <div class="stat-card full-width">
            <div style="text-align: left;">
                <div class="stat-value" id="dash-ruku-left" style="font-size: 1.5rem;">0</div>
                <div class="stat-label">Rukus Remaining</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-value" id="dash-ruku-done" style="font-size: 1.5rem; color: var(--accent);">0</div>
                <div class="stat-label">Rukus Read</div>
            </div>
        </div>
    </div>

    <div class="container" id="para-list">
        <!-- List Items Generated Here -->
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal" onclick="closeEditModal(event)">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Para 1</h2>
                <div class="modal-arabic" id="modal-arabic">ÿßŸÑŸÖ</div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted);">
                    Total Rukus: <strong id="modal-total-count">16</strong> 
                    <button onclick="adjustTotal(1)" style="border:1px solid var(--border); background:var(--bg); border-radius:4px; margin-left:5px; cursor:pointer;">+</button>
                    <button onclick="adjustTotal(-1)" style="border:1px solid var(--border); background:var(--bg); border-radius:4px; cursor:pointer;">-</button>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn-action" onclick="markAllRukus(true)">Select All</button>
                <button class="btn-action" onclick="markAllRukus(false)">Clear All</button>
            </div>
            
            <div class="ruku-grid" id="ruku-grid">
                <!-- Bubbles -->
            </div>

            <button class="btn-primary" onclick="closeEditModal()">Save Progress</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal" onclick="closeSettingsModal(event)">
        <div class="modal-sheet" style="max-height: 50vh;" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <h2 style="text-align:center; margin-bottom:20px; font-weight:700;">Settings</h2>
            
            <div class="settings-option" onclick="exportData()">
                <div>
                    <h4>Backup Data</h4>
                    <p>Download a file to save progress</p>
                </div>
                <span>üì•</span>
            </div>
            
            <div class="settings-option" onclick="triggerImport()">
                <div>
                    <h4>Restore Data</h4>
                    <p>Load progress from a backup file</p>
                </div>
                <span>üì§</span>
            </div>
            <input type="file" id="import-file" style="display: none;" onchange="importData(this)">

            <div class="settings-option" onclick="resetAll()">
                <div>
                    <h4 style="color: #ef4444;">Reset Everything</h4>
                    <p>Clear all progress and start over</p>
                </div>
                <span>‚ö†Ô∏è</span>
            </div>
        </div>
    </div>

<script>
    // --- Data ---
    const defaultParaData = [
        { id: 1, name: "Alif Lam Meem", ar: "ÿßŸÑŸÖ", rukus: 16 },
        { id: 2, name: "Sayaqool", ar: "ÿ≥ŸéŸäŸéŸÇŸèŸàŸÑŸè", rukus: 16 },
        { id: 3, name: "Tilkal Rusull", ar: "ÿ™ŸêŸÑŸíŸÉŸé ÿßŸÑÿ±ŸèŸëÿ≥ŸèŸÑŸè", rukus: 20 },
        { id: 4, name: "Lan Tanaloo", ar: "ŸÑŸéŸÜŸí ÿ™ŸéŸÜŸéÿßŸÑŸèŸàÿß", rukus: 16 },
        { id: 5, name: "Wal Mohsanat", ar: "ŸàŸéÿßŸÑŸíŸÖŸèÿ≠ŸíÿµŸéŸÜŸéÿßÿ™Ÿè", rukus: 14 },
        { id: 6, name: "La Yuhibbullah", ar: "ŸÑŸéÿß ŸäŸèÿ≠Ÿêÿ®ŸèŸë ÿßŸÑŸÑŸéŸëŸáŸè", rukus: 20 },
        { id: 7, name: "Wa Iza Samiu", ar: "ŸàŸéÿ•Ÿêÿ∞Ÿéÿß ÿ≥ŸéŸÖŸêÿπŸèŸàÿß", rukus: 16 },
        { id: 8, name: "Wa Lau Annana", ar: "ŸàŸéŸÑŸéŸàŸí ÿ£ŸéŸÜŸéŸëŸÜŸéÿß", rukus: 16 },
        { id: 9, name: "Qalal Malao", ar: "ŸÇŸéÿßŸÑŸé ÿßŸÑŸíŸÖŸéŸÑŸéÿ£Ÿè", rukus: 24 },
        { id: 10, name: "Wa A'lamu", ar: "ŸàŸéÿßÿπŸíŸÑŸéŸÖŸèŸàÿß", rukus: 11 },
        { id: 11, name: "Yatazeroon", ar: "ŸäŸéÿπŸíÿ™Ÿéÿ∞Ÿêÿ±ŸèŸàŸÜŸé", rukus: 21 },
        { id: 12, name: "Wa Mamin Da'abat", ar: "ŸàŸéŸÖŸéÿß ŸÖŸêŸÜŸí ÿØŸéÿßÿ®ŸéŸëÿ©Ÿç", rukus: 20 },
        { id: 13, name: "Wa Ma Ubiroo", ar: "ŸàŸéŸÖŸéÿß ÿ£Ÿèÿ®Ÿéÿ±ŸêŸëÿ¶Ÿè", rukus: 13 },
        { id: 14, name: "Rubama", ar: "ÿ±Ÿèÿ®ŸéŸÖŸéÿß", rukus: 18 },
        { id: 15, name: "Subhanallazi", ar: "ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿßŸÑŸéŸëÿ∞ŸêŸä", rukus: 20 },
        { id: 16, name: "Qala Alam", ar: "ŸÇŸéÿßŸÑŸé ÿ£ŸéŸÑŸéŸÖŸí", rukus: 20 },
        { id: 17, name: "Aqtarabo", ar: "ÿßŸÇŸíÿ™Ÿéÿ±Ÿéÿ®Ÿé", rukus: 17 },
        { id: 18, name: "Qadd Aflaha", ar: "ŸÇŸéÿØŸí ÿ£ŸéŸÅŸíŸÑŸéÿ≠Ÿé", rukus: 14 },
        { id: 19, name: "Wa Qalallazina", ar: "ŸàŸéŸÇŸéÿßŸÑŸé ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé", rukus: 19 },
        { id: 20, name: "A'man Khalaqa", ar: "ÿ£ŸéŸÖŸéŸëŸÜŸí ÿÆŸéŸÑŸéŸÇŸé", rukus: 16 },
        { id: 21, name: "Utlu Ma Oohi", ar: "ÿßÿ™ŸíŸÑŸè ŸÖŸéÿß ÿ£ŸèŸàÿ≠ŸêŸäŸé", rukus: 15 },
        { id: 22, name: "Wa Manyaqnut", ar: "ŸàŸéŸÖŸéŸÜŸí ŸäŸéŸÇŸíŸÜŸèÿ™Ÿí", rukus: 16 },
        { id: 23, name: "Wa Mali", ar: "ŸàŸéŸÖŸéÿß ŸÑŸêŸä", rukus: 14 },
        { id: 24, name: "Faman Azlam", ar: "ŸÅŸéŸÖŸéŸÜŸí ÿ£Ÿéÿ∏ŸíŸÑŸéŸÖŸè", rukus: 20 },
        { id: 25, name: "Elahe Yuruddo", ar: "ÿ•ŸêŸÑŸéŸäŸíŸáŸê ŸäŸèÿ±ŸéÿØŸèŸë", rukus: 12 },
        { id: 26, name: "Ha'a Meem", ar: "ÿ≠ŸÖ", rukus: 19 },
        { id: 27, name: "Qala Fama Khatbukum", ar: "ŸÇŸéÿßŸÑŸé ŸÅŸéŸÖŸéÿß ÿÆŸéÿ∑Ÿíÿ®ŸèŸÉŸèŸÖŸí", rukus: 20 },
        { id: 28, name: "Qadd Sami Allah", ar: "ŸÇŸéÿØŸí ÿ≥ŸéŸÖŸêÿπŸé ÿßŸÑŸÑŸéŸëŸáŸè", rukus: 20 },
        { id: 29, name: "Tabarakallazi", ar: "ÿ™Ÿéÿ®Ÿéÿßÿ±ŸéŸÉŸé ÿßŸÑŸéŸëÿ∞ŸêŸä", rukus: 22 },
        { id: 30, name: "Amma Yatasa'aloon", ar: "ÿπŸéŸÖŸéŸë ŸäŸéÿ™Ÿéÿ≥Ÿéÿßÿ°ŸéŸÑŸèŸàŸÜŸé", rukus: 39 }
    ];

    // State Variables
    let progressData = JSON.parse(localStorage.getItem('qt_progress')) || {};
    let customCounts = JSON.parse(localStorage.getItem('qt_counts')) || {};
    let lastActivePara = localStorage.getItem('qt_last_active') || null;
    let currentParaId = null;

    // --- Init ---
    function init() {
        applyTheme();
        renderList();
        updateDashboard();
    }

    // --- Core Logic ---
    function getTotalRukus(id) {
        return customCounts[id] || defaultParaData.find(p => p.id === id).rukus;
    }

    function renderList() {
        const container = document.getElementById('para-list');
        container.innerHTML = '';

        defaultParaData.forEach(para => {
            const total = getTotalRukus(para.id);
            const doneList = progressData[para.id] || [];
            const validDone = doneList.filter(r => r <= total);
            const isComplete = validDone.length >= total && total > 0;
            const percent = total > 0 ? (validDone.length / total) * 100 : 0;
            const isLastActive = lastActivePara == para.id;

            const card = document.createElement('div');
            card.className = `para-card ${isComplete ? 'completed' : ''} ${isLastActive && !isComplete ? 'last-active' : ''}`;
            card.onclick = () => openEditModal(para.id);

            card.innerHTML = `
                ${isLastActive && !isComplete ? '<div class="last-active-badge">Last Read</div>' : ''}
                <div class="para-icon">${para.id}</div>
                <div class="para-content">
                    <div class="para-title">${para.name}</div>
                    <div class="para-arabic">${para.ar}</div>
                </div>
                <div class="para-meta">
                    <span class="meta-text">${validDone.length} / ${total}</span>
                    <div class="mini-bar">
                        <div class="mini-fill" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // --- Modals ---
    function openEditModal(id) {
        currentParaId = id;
        lastActivePara = id;
        localStorage.setItem('qt_last_active', id);
        
        const para = defaultParaData.find(p => p.id === id);
        document.getElementById('modal-title').innerText = `Para ${para.id}`;
        document.getElementById('modal-arabic').innerText = para.ar;
        document.getElementById('modal-total-count').innerText = getTotalRukus(id);
        
        renderBubbles();
        document.getElementById('edit-modal').classList.add('active');
    }

    function renderBubbles() {
        const total = getTotalRukus(currentParaId);
        const doneList = progressData[currentParaId] || [];
        const grid = document.getElementById('ruku-grid');
        grid.innerHTML = '';

        for (let i = 1; i <= total; i++) {
            const btn = document.createElement('div');
            const isDone = doneList.includes(i);
            btn.className = `ruku-bubble ${isDone ? 'checked' : ''}`;
            btn.innerText = i;
            btn.onclick = () => toggleRuku(i);
            grid.appendChild(btn);
        }
    }

    function toggleRuku(idx) {
        if(!progressData[currentParaId]) progressData[currentParaId] = [];
        const list = progressData[currentParaId];
        
        if(list.includes(idx)) {
            const index = list.indexOf(idx);
            list.splice(index, 1);
        } else {
            list.push(idx);
        }
        
        saveData();
        renderBubbles();
    }

    function markAllRukus(status) {
        const total = getTotalRukus(currentParaId);
        if(status) {
            progressData[currentParaId] = Array.from({length: total}, (_, i) => i + 1);
        } else {
            progressData[currentParaId] = [];
        }
        saveData();
        renderBubbles();
    }

    function adjustTotal(amount) {
        const current = getTotalRukus(currentParaId);
        const next = Math.max(1, Math.min(60, current + amount));
        customCounts[currentParaId] = next;
        localStorage.setItem('qt_counts', JSON.stringify(customCounts));
        
        document.getElementById('modal-total-count').innerText = next;
        renderBubbles();
    }

    function closeEditModal(e) {
        if(e && e.target !== document.getElementById('edit-modal')) return;
        
        // Check for celebration
        const total = getTotalRukus(currentParaId);
        const done = (progressData[currentParaId] || []).length;
        if(done >= total && total > 0) popConfetti();

        document.getElementById('edit-modal').classList.remove('active');
        renderList();
        updateDashboard();
    }

    // --- Dashboard & Stats ---
    function updateDashboard() {
        let totalParas = 0;
        let totalRukus = 0;
        let readRukus = 0;
        let completeParas = 0;

        defaultParaData.forEach(p => {
            const t = getTotalRukus(p.id);
            const d = (progressData[p.id] || []).filter(r => r <= t).length;
            totalParas++;
            totalRukus += t;
            readRukus += d;
            if(d >= t && t > 0) completeParas++;
        });

        const percent = totalRukus > 0 ? Math.round((readRukus / totalRukus) * 100) : 0;
        const offset = 157 - (157 * percent) / 100;

        document.getElementById('dash-paras').innerText = completeParas;
        document.getElementById('dash-percent').innerText = `${percent}%`;
        document.getElementById('progress-circle').style.strokeDashoffset = offset;
        document.getElementById('dash-ruku-left').innerText = totalRukus - readRukus;
        document.getElementById('dash-ruku-done').innerText = readRukus;
    }

    function saveData() {
        localStorage.setItem('qt_progress', JSON.stringify(progressData));
    }

    // --- Settings & Utils ---
    function openSettings() {
        document.getElementById('settings-modal').classList.add('active');
    }

    function closeSettingsModal(e) {
        if(e && e.target !== document.getElementById('settings-modal')) return;
        document.getElementById('settings-modal').classList.remove('active');
    }

    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', next);
        localStorage.setItem('qt_theme', next);
        document.getElementById('theme-icon').innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function applyTheme() {
        const theme = localStorage.getItem('qt_theme') || 'light';
        document.body.setAttribute('data-theme', theme);
        document.getElementById('theme-icon').innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function resetAll() {
        if(confirm('Are you sure? This will delete all progress.')) {
            localStorage.removeItem('qt_progress');
            localStorage.removeItem('qt_counts');
            localStorage.removeItem('qt_last_active');
            location.reload();
        }
    }

    function exportData() {
        const data = {
            progress: progressData,
            counts: customCounts,
            lastActive: lastActivePara,
            theme: document.body.getAttribute('data-theme')
        };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quran_tracker_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function triggerImport() {
        document.getElementById('import-file').click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.progress) localStorage.setItem('qt_progress', JSON.stringify(data.progress));
                if(data.counts) localStorage.setItem('qt_counts', JSON.stringify(data.counts));
                if(data.lastActive) localStorage.setItem('qt_last_active', data.lastActive);
                if(data.theme) localStorage.setItem('qt_theme', data.theme);
                location.reload();
            } catch(err) {
                alert('Invalid file format');
            }
        };
        reader.readAsText(file);
    }

    // --- Confetti Effect (Simple) ---
    function popConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const pieces = [];
        const colors = ['#fcd34d', '#34d399', '#60a5fa', '#f87171'];
        
        for(let i=0; i<100; i++) {
            pieces.push({
                x: canvas.width/2, y: canvas.height/2,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10 - 5,
                color: colors[Math.floor(Math.random()*colors.length)],
                size: Math.random() * 8 + 4
            });
        }

        let frame = 0;
        function animate() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            let active = false;
            pieces.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // gravity
                p.size *= 0.96; // shrink
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
                if(p.size > 0.5) active = true;
            });
            
            if(active && frame < 100) {
                frame++;
                requestAnimationFrame(animate);
            } else {
                ctx.clearRect(0,0, canvas.width, canvas.height);
            }
        }
        animate();
    }

    // Start
    init();

</script>
</body>
</html>
