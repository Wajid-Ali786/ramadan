<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quran Tracker ¬∑ Noble Journey</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* premium light ‚Äî refined */
            --primary: #0b7b5a;
            --primary-soft: #e6f7f0;
            --primary-gradient: linear-gradient(145deg, #0b7b5a, #065f46);
            --accent: #b45309;
            --accent-gradient: linear-gradient(145deg, #fbbf24, #b45309);
            --bg: #f9fcff;
            --card-bg: #ffffff;
            --text-main: #13294e;
            --text-muted: #5e6f88;
            --border: #dee7f2;
            --shadow: 0 18px 30px -12px rgba(0, 40, 20, 0.12);
            --shadow-hover: 0 24px 44px -12px rgba(6, 95, 70, 0.25);
            --glass: rgba(255, 255, 255, 0.8);
            --radius-xl: 28px;
            --radius-lg: 20px;
            --radius-md: 16px;
        }

        [data-theme="dark"] {
            --primary: #1fad7a;
            --primary-soft: #1a3a32;
            --primary-gradient: linear-gradient(145deg, #1fad7a, #0b7b5a);
            --accent: #fbbf24;
            --accent-gradient: linear-gradient(145deg, #fcd34d, #b45309);
            --bg: #0c1622;
            --card-bg: #1f2a3f;
            --text-main: #f0f6ff;
            --text-muted: #a9bbd4;
            --border: #2d394f;
            --shadow: 0 20px 35px -8px #00000055;
            --shadow-hover: 0 28px 48px -12px #000000cc;
            --glass: rgba(20, 30, 45, 0.85);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
            scroll-behavior: smooth;
        }

        /* glass header */
        .app-header {
            background: var(--glass);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            padding: 18px 26px;
            position: sticky;
            top: 0;
            z-index: 60;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo-area h1 {
            font-size: 1.7rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.7px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 48px;
            height: 48px;
            border-radius: 18px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.02);
            transition: 0.2s;
        }

        .icon-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        /* datetime card */
        .datetime-widget {
            max-width: 800px;
            margin: 20px auto 10px;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-display {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -1.5px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .date-display {
            font-weight: 600;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .hijri-display {
            background: var(--primary-soft);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }

        /* tabs */
        .nav-tabs {
            max-width: 800px;
            margin: 24px auto 18px;
            padding: 0 24px;
            display: flex;
            gap: 14px;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 10px;
            border-radius: 40px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-muted);
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.25s;
        }

        .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 12px 22px -8px var(--primary);
            transform: scale(1.02);
        }

        /* dashboard cards ‚Äî elevated */
        .dashboard {
            padding: 0 24px 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            max-width: 800px;
            margin: 0 auto;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 24px 12px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: 0.2s;
        }

        .stat-card.full-width {
            grid-column: span 2;
            flex-direction: row;
            justify-content: space-between;
            padding: 22px 36px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .stat-value.highlight {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* progress ring refined */
        .progress-ring {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 6px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 6;
        }

        .bg-ring {
            stroke: var(--border);
        }

        .fill-ring {
            stroke: var(--primary);
            stroke-dasharray: 226;
            /* 2pi*36 ‚âà226 */
            stroke-dashoffset: 226;
            transition: stroke-dashoffset 0.7s cubic-bezier(0.2, 0.8, 0.4, 1);
            stroke-linecap: round;
        }

        .ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* cards ‚Äî premium + floating */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
            display: grid;
            gap: 18px;
        }

        .view-section {
            display: none;
        }

        .view-section.active.container {
            display: grid;
        }

        #surah-list {
            display: grid;
            gap: 18px;
        }

        .list-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 22px 22px 22px 18px;
            display: flex;
            align-items: center;
            gap: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .list-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 0% 30%, var(--primary-soft), transparent 70%);
            opacity: 0;
            transition: 0.4s;
        }

        .list-card:hover::before {
            opacity: 0.5;
        }

        .list-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }

        .para-id-meta {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .card-icon-wrap {
            position: relative;
            z-index: 2;
        }

        .para-icon {
            width: 64px;
            height: 64px;
            border-radius: 22px;
            background: var(--primary-soft);
            color: var(--primary);
            font-weight: 800;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
            transition: 0.2s;
        }

        .list-card:hover .para-icon {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        .card-content {
            flex: 1;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .card-arabic {
            font-family: 'Amiri', serif;
            font-size: 1.8rem;
            color: var(--accent);
            line-height: 1.2;
        }

        .last-read-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--primary-soft);
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 5px 14px;
            border-radius: 40px;
            margin-top: 8px;
            border: 1px solid var(--border);
        }

        .card-meta {
            text-align: right;
            min-width: 80px;
            z-index: 2;
        }

        .meta-text {
            font-weight: 800;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .mini-bar {
            height: 8px;
            background: var(--border);
            border-radius: 20px;
            overflow: hidden;
        }

        .mini-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            border-radius: 20px;
        }

        .list-card.completed {
            background: var(--primary-gradient);
        }

        .list-card.completed .card-title,
        .list-card.completed .card-arabic,
        .list-card.completed .meta-text,
        .list-card.completed .last-read-tag {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border-color: white;
        }

        .list-card.completed .para-icon {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        /* MODALS premium sheet */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 10, 10, 0.6);
            backdrop-filter: blur(8px);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-sheet {
            background: var(--card-bg);
            width: 100%;
            max-width: 550px;
            border-radius: 36px 36px 0 0;
            padding: 30px 28px 28px;
            transform: translateY(100%);
            transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 -20px 50px rgba(0, 0, 0, 0.2);
            max-height: 85vh;
            overflow-y: auto;
            border-top: 3px solid var(--primary);
        }

        .modal-overlay.active .modal-sheet {
            transform: translateY(0);
        }

        @media (min-width: 550px) {
            .modal-overlay {
                align-items: center;
            }

            .modal-sheet {
                border-radius: 40px;
                transform: scale(0.9) translateY(30px);
            }

            .modal-overlay.active .modal-sheet {
                transform: scale(1) translateY(0);
            }
        }

        .handle-bar {
            width: 50px;
            height: 5px;
            background: var(--border);
            border-radius: 10px;
            margin: 0 auto 20px;
        }

        .modal-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .modal-arabic {
            font-family: 'Amiri', serif;
            font-size: 2.4rem;
            color: var(--accent);
        }

        .info-btn {
            background: var(--primary-soft);
            color: var(--primary);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 20px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .info-btn:hover {
            background: var(--primary);
            color: white;
            transform: rotate(10deg);
        }

        .ruku-controlar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ruku-add,
        .ruku-del {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 700;
            cursor: pointer;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn-action {
            flex: 1;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--bg);
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-action:hover {
            background: var(--border);
            color: var(--text-main);
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .ruku-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(62px, 1fr));
            gap: 14px;
            margin: 28px 0;
        }

        .ruku-bubble {
            aspect-ratio: 1;
            border-radius: 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.15s;
        }

        .ruku-bubble.checked {
            background: var(--primary-gradient);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 10px 18px -6px var(--primary);
            transform: scale(1.04);
        }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 40px;
            font-weight: 800;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 14px 22px -12px var(--primary);
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        /* surah counter */
        .huge-counter {
            font-size: 6rem;
            font-weight: 800;
            text-align: center;
            color: var(--primary);
            line-height: 1;
            margin: 10px 0 20px;
        }

        .counter-controls {
            display: flex;
            gap: 14px;
            margin-bottom: 28px;
            justify-content: center;
        }

        .counter-btn {
            padding: 22px;
            border-radius: 36px;
            font-weight: 800;
            font-size: 2rem;
            border: none;
            cursor: pointer;
        }

        .btn-minus {
            background: var(--bg);
            color: var(--text-muted);
            border: 2px solid var(--border);
            padding: 10px 30px;
        }

        .btn-plus {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 14px 28px -10px var(--primary);
            padding: 10px 30px;
        }

        /* history modal */
        .history-list {
            max-height: 350px;
            overflow-y: auto;
            border-radius: 24px;
            background: var(--bg);
            border: 1px solid var(--border);
            margin: 20px 0;
        }

        .history-item {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .h-title {
            font-weight: 800;
        }

        .h-time {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* toast */
        #toast-container {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 16px 30px;
            border-radius: 60px;
            font-weight: 600;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 12px;
            align-items: center;
            animation: slideUp 0.3s forwards;
            border-left: 6px solid var(--primary);
        }

        .toast.error {
            border-left-color: #ef4444;
        }
    </style>
</head>

<body>
    <canvas id="confetti"
        style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9998;"></canvas>

    <header class="app-header">
        <div class="logo-area">
            <h1>€û Quran¬∑Pro</h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleTheme()" id="theme-icon">üåô</button>
            <button class="icon-btn" onclick="openModal('settings-modal')">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="datetime-widget">
        <div>
            <div class="time-display" id="sys-time">--:--</div>
            <div class="date-display" id="sys-date"></div>
        </div>
        <div><span class="hijri-display" id="sys-hijri">--</span></div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" id="tab-paras" onclick="switchTab('paras')">Juz' (Paras)</button>
        <button class="tab-btn" id="tab-surahs" onclick="switchTab('surahs')">Surahs & Wazaif</button>
    </div>

    <div class="dashboard">
        <div class="stat-card">
            <div class="stat-value highlight" id="dash-paras">0</div>
            <div class="stat-label">Paras completed</div>
        </div>
        <div class="stat-card">
            <div class="progress-ring">
                <svg>
                    <circle class="bg-ring" cx="40" cy="40" r="36"></circle>
                    <circle class="fill-ring" id="progress-circle" cx="40" cy="40" r="36"></circle>
                </svg>
                <div class="ring-text" id="dash-percent">0%</div>
            </div>
            <div class="stat-label">Overall</div>
        </div>
        <div class="stat-card full-width">
            <div>
                <div class="stat-value" id="dash-ruku-left">0</div>
                <div class="stat-label">Rukus left</div>
            </div>
            <div style="text-align:right;">
                <div class="stat-value" id="dash-surah-total" style="color:var(--accent);">0</div>
                <div class="stat-label">Surah reads</div>
            </div>
        </div>
    </div>

    <!-- views -->
    <div id="view-paras" class="view-section active container"></div>
    <div id="view-surahs" class="view-section container">
        <div id="surah-list"></div>
        <button class="btn-primary"
            style="background:var(--card-bg); color:var(--text-main); border:2px dashed var(--border); box-shadow:none;"
            onclick="openModal('add-surah-modal')">+ Add custom surah / wird</button>
    </div>

    <div id="toast-container"></div>

    <!-- EDIT PARA MODAL -->
    <div class="modal-overlay" id="edit-modal" onclick="closeModal('edit-modal', true)">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <div class="modal-header-flex">
                <div>
                    <h2 class="modal-title" id="modal-title">Para 1</h2>
                    <div class="modal-arabic" id="modal-arabic">ÿßŸÑŸÖ</div>
                </div>
                <button class="info-btn" onclick="openHistory('para')">‚è±Ô∏è</button>
            </div>
            <div class="ruku-controlar">
                <span style="font-weight:600;">Rukus: <span id="modal-total-count">16</span></span>
                <div style=" display: flex; gap: 15px; ">
                    <button class="ruku-add" onclick="adjustTotal(-1)">‚àí</button>
                    <button class="ruku-del" onclick="adjustTotal(1)">+</button>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn-action" onclick="markAllRukus(true)">Select All</button>
                <button class="btn-action" onclick="markAllRukus(false)">Clear All</button>
            </div>
            <div class="ruku-grid" id="ruku-grid"></div>
            <button class="btn-primary" onclick="closeModal('edit-modal', true)">Save progress</button>
        </div>
    </div>

    <!-- SURAH MODAL -->
    <div class="modal-overlay" id="surah-modal" onclick="closeModal('surah-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <div class="modal-header-flex">
                <div>
                    <h2 class="modal-title" id="s-modal-title">Surah Yaseen</h2>
                    <div class="modal-arabic" id="s-modal-arabic">Ÿäÿ≥</div>
                </div>
                <button class="info-btn" onclick="openHistory('surah')">üìã</button>
            </div>
            <div class="huge-counter" id="s-modal-count">0</div>
            <div class="counter-controls">
                <button class="counter-btn btn-minus" onclick="modifySurahCount(-1)">‚àí</button>
                <button class="counter-btn btn-plus" onclick="modifySurahCount(1)">+1 recite</button>
            </div>
            <button class="btn-primary"
                style="background:var(--bg); color:var(--text-main); border:2px solid var(--border); box-shadow:none;"
                onclick="closeModal('surah-modal')">Close</button>
        </div>
    </div>

    <!-- HISTORY / TIMESTAMP MODAL (shows date & time) -->
    <div class="modal-overlay" id="history-modal" onclick="closeModal('history-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <h2 class="modal-title" style="font-size:1.8rem;" id="h-modal-title">History</h2>
            <div class="history-list" id="history-list-container"></div>
            <button class="btn-primary" onclick="closeModal('history-modal')">Close</button>
        </div>
    </div>

    <!-- ADD CUSTOM SURAH -->
    <div class="modal-overlay" id="add-surah-modal" onclick="closeModal('add-surah-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <h2 class="modal-title" style="margin-bottom:20px;">Add wird / surah</h2>
            <input type="text" id="new-surah-name" placeholder="Name (e.g. Al-Kahf)"
                style="width:100%; padding:16px; border-radius:20px; border:2px solid var(--border); margin-bottom:12px; background:var(--bg); color:var(--text-main);">
            <input type="text" id="new-surah-ar" placeholder="Arabic (optional)"
                style="width:100%; padding:16px; border-radius:20px; border:2px solid var(--border); margin-bottom:12px; font-family:'Amiri'; font-size:1.4rem; background:var(--bg); color:var(--text-main);"
                dir="rtl">
            <input type="text" id="new-surah-trans" placeholder="Subtitle (optional)"
                style="width:100%; padding:16px; border-radius:20px; border:2px solid var(--border); margin-bottom:24px; background:var(--bg);">
            <button class="btn-primary" onclick="saveCustomSurah()">Save</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-modal" onclick="closeModal('settings-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="handle-bar"></div>
            <h2 class="modal-title" style="text-align:center;">Settings</h2>
            <div style="margin: 30px 0; display: flex; flex-direction: column; gap:14px;">
                <button class="btn-primary"
                    style="background:var(--bg); color:var(--text-main); border:2px solid var(--border); box-shadow:none;"
                    onclick="exportData()">üì• Backup data</button>
                <button class="btn-primary"
                    style="background:var(--bg); color:var(--text-main); border:2px solid var(--border); box-shadow:none;"
                    onclick="triggerImport()">üì§ Restore data</button>
                <input type="file" id="import-file" style="display:none;" onchange="importData(this)">
                <button class="btn-primary" style="background:rgba(239,68,68,0.1); color:#ef4444; box-shadow:none;"
                    onclick="resetAll()">‚ö†Ô∏è Factory reset</button>
            </div>
        </div>
    </div>

    <script type="module">
        (function () {
            // ----- DATA MODELS (timestamp-aware) -----
            const defaultParaData = [
                { id: 1, name: "Alif Lam Meem", ar: "ÿßŸÑŸÖ", rukus: 16 }, { id: 2, name: "Sayaqool", ar: "ÿ≥ŸéŸäŸéŸÇŸèŸàŸÑŸè", rukus: 16 },
                { id: 3, name: "Tilkal Rusull", ar: "ÿ™ŸêŸÑŸíŸÉŸé ÿßŸÑÿ±ŸèŸëÿ≥ŸèŸÑŸè", rukus: 20 }, { id: 4, name: "Lan Tanaloo", ar: "ŸÑŸéŸÜŸí ÿ™ŸéŸÜŸéÿßŸÑŸèŸàÿß", rukus: 16 },
                { id: 5, name: "Wal Mohsanat", ar: "ŸàŸéÿßŸÑŸíŸÖŸèÿ≠ŸíÿµŸéŸÜŸéÿßÿ™Ÿè", rukus: 14 }, { id: 6, name: "La Yuhibbullah", ar: "ŸÑŸéÿß ŸäŸèÿ≠Ÿêÿ®ŸèŸë ÿßŸÑŸÑŸéŸëŸáŸè", rukus: 20 },
                { id: 7, name: "Wa Iza Samiu", ar: "ŸàŸéÿ•Ÿêÿ∞Ÿéÿß ÿ≥ŸéŸÖŸêÿπŸèŸàÿß", rukus: 16 }, { id: 8, name: "Wa Lau Annana", ar: "ŸàŸéŸÑŸéŸàŸí ÿ£ŸéŸÜŸéŸëŸÜŸéÿß", rukus: 16 },
                { id: 9, name: "Qalal Malao", ar: "ŸÇŸéÿßŸÑŸé ÿßŸÑŸíŸÖŸéŸÑŸéÿ£Ÿè", rukus: 24 }, { id: 10, name: "Wa A'lamu", ar: "ŸàŸéÿßÿπŸíŸÑŸéŸÖŸèŸàÿß", rukus: 11 },
                { id: 11, name: "Yatazeroon", ar: "ŸäŸéÿπŸíÿ™Ÿéÿ∞Ÿêÿ±ŸèŸàŸÜŸé", rukus: 21 }, { id: 12, name: "Wa Mamin Da'abat", ar: "ŸàŸéŸÖŸéÿß ŸÖŸêŸÜŸí ÿØŸéÿßÿ®ŸéŸëÿ©Ÿç", rukus: 20 },
                { id: 13, name: "Wa Ma Ubiroo", ar: "ŸàŸéŸÖŸéÿß ÿ£Ÿèÿ®Ÿéÿ±ŸêŸëÿ¶Ÿè", rukus: 13 }, { id: 14, name: "Rubama", ar: "ÿ±Ÿèÿ®ŸéŸÖŸéÿß", rukus: 18 },
                { id: 15, name: "Subhanallazi", ar: "ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿßŸÑŸéŸëÿ∞ŸêŸä", rukus: 20 }, { id: 16, name: "Qala Alam", ar: "ŸÇŸéÿßŸÑŸé ÿ£ŸéŸÑŸéŸÖŸí", rukus: 20 },
                { id: 17, name: "Aqtarabo", ar: "ÿßŸÇŸíÿ™Ÿéÿ±Ÿéÿ®Ÿé", rukus: 17 }, { id: 18, name: "Qadd Aflaha", ar: "ŸÇŸéÿØŸí ÿ£ŸéŸÅŸíŸÑŸéÿ≠Ÿé", rukus: 14 },
                { id: 19, name: "Wa Qalallazina", ar: "ŸàŸéŸÇŸéÿßŸÑŸé ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé", rukus: 19 }, { id: 20, name: "A'man Khalaqa", ar: "ÿ£ŸéŸÖŸéŸëŸÜŸí ÿÆŸéŸÑŸéŸÇŸé", rukus: 16 },
                { id: 21, name: "Utlu Ma Oohi", ar: "ÿßÿ™ŸíŸÑŸè ŸÖŸéÿß ÿ£ŸèŸàÿ≠ŸêŸäŸé", rukus: 15 }, { id: 22, name: "Wa Manyaqnut", ar: "ŸàŸéŸÖŸéŸÜŸí ŸäŸéŸÇŸíŸÜŸèÿ™Ÿí", rukus: 16 },
                { id: 23, name: "Wa Mali", ar: "ŸàŸéŸÖŸéÿß ŸÑŸêŸä", rukus: 14 }, { id: 24, name: "Faman Azlam", ar: "ŸÅŸéŸÖŸéŸÜŸí ÿ£Ÿéÿ∏ŸíŸÑŸéŸÖŸè", rukus: 20 },
                { id: 25, name: "Elahe Yuruddo", ar: "ÿ•ŸêŸÑŸéŸäŸíŸáŸê ŸäŸèÿ±ŸéÿØŸèŸë", rukus: 12 }, { id: 26, name: "Ha'a Meem", ar: "ÿ≠ŸÖ", rukus: 19 },
                { id: 27, name: "Qala Fama Khatbukum", ar: "ŸÇŸéÿßŸÑŸé ŸÅŸéŸÖŸéÿß ÿÆŸéÿ∑Ÿíÿ®ŸèŸÉŸèŸÖŸí", rukus: 20 }, { id: 28, name: "Qadd Sami Allah", ar: "ŸÇŸéÿØŸí ÿ≥ŸéŸÖŸêÿπŸé ÿßŸÑŸÑŸéŸëŸáŸè", rukus: 20 },
                { id: 29, name: "Tabarakallazi", ar: "ÿ™Ÿéÿ®Ÿéÿßÿ±ŸéŸÉŸé ÿßŸÑŸéŸëÿ∞ŸêŸä", rukus: 22 }, { id: 30, name: "Amma Yatasa'aloon", ar: "ÿπŸéŸÖŸéŸë ŸäŸéÿ™Ÿéÿ≥Ÿéÿßÿ°ŸéŸÑŸèŸàŸÜŸé", rukus: 39 }
            ];

            const defaultSurahs = [
                { id: "s_yaseen", name: "Surah Yaseen", ar: "Ÿäÿ≥", trans: "Heart of the Quran" },
                { id: "s_mulk", name: "Surah Al-Mulk", ar: "ÿßŸÑŸÖŸÑŸÉ", trans: "Protection" },
                { id: "s_rahman", name: "Surah Ar-Rahman", ar: "ÿßŸÑÿ±ÿ≠ŸÖŸÜ", trans: "Beauty" },
                { id: "s_waqiah", name: "Surah Al-Waqi'ah", ar: "ÿßŸÑŸàÿßŸÇÿπÿ©", trans: "Sustenance" }
            ];

            // -------------------- GLOBAL STATE (timestamp objects) --------------------
            let progressData = JSON.parse(localStorage.getItem('qtp_progress')) || {};      // { paraId: { rukuNum: timestamp } }
            let customCounts = JSON.parse(localStorage.getItem('qtp_counts')) || {};        // { paraId: customTotal }
            let surahHistory = JSON.parse(localStorage.getItem('qtp_surah_history')) || {}; // { surahId: [timestamp, ...] }
            let customSurahs = JSON.parse(localStorage.getItem('qtp_custom_surahs')) || [];

            // migrate old array-based progress (if any)
            const oldRaw = JSON.parse(localStorage.getItem('qtp_progress_legacy'));
            if (!oldRaw) {
                // check if any progressData is array, convert
                for (let key in progressData) {
                    if (Array.isArray(progressData[key])) {
                        let arr = progressData[key];
                        let obj = {};
                        arr.forEach(r => obj[r] = Date.now());
                        progressData[key] = obj;
                    }
                }
            }

            // current IDs
            let currentParaId = null;
            let currentSurahId = null;

            // -------------------- helper: format timestamp nicely --------------------
            function formatTime(t) {
                if (!t) return '';
                let d = new Date(t);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' ¬∑ ' +
                    d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            function timeAgo(ts) {
                let diff = (Date.now() - ts) / 1000;
                if (diff < 60) return 'just now';
                if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
                if (diff < 86400) return Math.floor(diff / 3600) + ' hr ago';
                if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
                return new Date(ts).toLocaleDateString();
            }

            // toast
            function showToast(msg, type = 'success') {
                let c = document.getElementById('toast-container');
                let t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚ö†Ô∏è'}</span><span>${msg}</span>`;
                c.appendChild(t);
                setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2600);
            }

            // tabs
            function switchTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                document.getElementById(`view-${tab}`).classList.add('active');
            }

            // ---- PARA RENDERING (with last read) ----
            function getTotalRukus(pid) { return customCounts[pid] || defaultParaData.find(p => p.id === pid).rukus; }

            function renderParas() {
                let container = document.getElementById('view-paras');
                container.innerHTML = '';
                defaultParaData.forEach(p => {
                    let total = getTotalRukus(p.id);
                    let rukuObj = progressData[p.id] || {};
                    let doneKeys = Object.keys(rukuObj).filter(k => parseInt(k) <= total);
                    let percent = total ? (doneKeys.length / total) * 100 : 0;
                    let latest = 0;
                    doneKeys.forEach(k => { if (rukuObj[k] > latest) latest = rukuObj[k]; });

                    let lastHtml = latest ? `<span class="last-read-tag">üïí ${timeAgo(latest)}</span>` : '';

                    let card = document.createElement('div');
                    card.className = `list-card ${doneKeys.length >= total && total > 0 ? 'completed' : ''}`;
                    card.onclick = () => openParaModal(p.id);
                    card.innerHTML = `
                        <div class="card-content">
                            <div class="card-arabic">${p.ar}</div>
                            <div class="card-title">${p.name}</div>
                            ${lastHtml}
                        </div>
                        <div class="para-id-meta">
                            <div class="card-icon-wrap"><div class="para-icon">${p.id}</div></div>
                            <div class="card-meta">
                                <span class="meta-text">${doneKeys.length}/${total}</span>
                                <div class="mini-bar"><div class="mini-fill" style="width:${percent}%"></div></div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function openParaModal(id) {
                currentParaId = id;
                let p = defaultParaData.find(x => x.id === id);
                document.getElementById('modal-title').innerText = `Juz ${p.id}`;
                document.getElementById('modal-arabic').innerText = p.ar;
                document.getElementById('modal-total-count').innerText = getTotalRukus(id);
                renderBubbles();
                openModal('edit-modal');
            }

            function renderBubbles() {
                let total = getTotalRukus(currentParaId);
                let obj = progressData[currentParaId] || {};
                let grid = document.getElementById('ruku-grid');
                grid.innerHTML = '';
                for (let i = 1; i <= total; i++) {
                    let b = document.createElement('div');
                    b.className = `ruku-bubble ${obj[i] ? 'checked' : ''}`;
                    b.innerText = i;
                    if (obj[i]) b.title = `‚úî ${formatTime(obj[i])}`;
                    b.onclick = () => toggleRuku(i);
                    grid.appendChild(b);
                }
            }

            function toggleRuku(idx) {
                if (!progressData[currentParaId]) progressData[currentParaId] = {};
                if (progressData[currentParaId][idx]) {
                    delete progressData[currentParaId][idx];
                    showToast(`Ruku ${idx} unmarked`, 'success');
                } else {
                    progressData[currentParaId][idx] = Date.now();
                    showToast(`Ruku ${idx} completed ‚ú®`);
                }
                saveAll(); renderBubbles(); renderParas(); updateDashboard();
            }

            function markAllRukus(status) {
                const total = getTotalRukus(currentParaId);

                if (!progressData[currentParaId]) {
                    progressData[currentParaId] = {};
                }

                if (status) {
                    // Mark all with timestamp
                    for (let i = 1; i <= total; i++) {
                        progressData[currentParaId][i] = Date.now();
                    }
                } else {
                    // Clear all properly
                    progressData[currentParaId] = {};
                }

                saveAll();
                renderBubbles();
                renderParas();
                updateDashboard();

                showToast(
                    status ? "All Rukus Marked" : "Cleared All Rukus",
                    status ? "success" : "error"
                );
            }

            function adjustTotal(delta) {
                let cur = getTotalRukus(currentParaId);
                let n = Math.min(60, Math.max(1, cur + delta));
                customCounts[currentParaId] = n;
                document.getElementById('modal-total-count').innerText = n;
                saveAll(); renderBubbles();
                showToast(`Save All ‚úÖ`);
            }

            // ---- SURAH LOGIC ----
            function getAllSurahs() { return [...defaultSurahs, ...customSurahs]; }

            function renderSurahs() {
                let container = document.getElementById('surah-list');
                container.innerHTML = '';
                getAllSurahs().forEach(s => {
                    let hist = surahHistory[s.id] || [];
                    let cnt = hist.length;
                    let latest = hist.length ? hist[hist.length - 1] : 0;
                    let lastHtml = latest ? `<span class="last-read-tag">üïí ${timeAgo(latest)}</span>` : '';

                    let card = document.createElement('div');
                    card.className = 'list-card';
                    card.onclick = () => openSurahModal(s.id);
                    card.innerHTML = `
                        <div class="card-icon-wrap"><div class="para-icon" style="background:var(--primary-soft); color:var(--primary);">${cnt}</div></div>
                        <div class="card-content">
                            <div class="card-title">${s.name}</div>
                            <div style="font-size:0.9rem; color:var(--text-muted);">${s.trans || ''}</div>
                            ${lastHtml}
                        </div>
                        <div class="card-meta">
                            <div class="card-arabic">${s.ar || ''}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function openSurahModal(id) {
                currentSurahId = id;
                let s = getAllSurahs().find(x => x.id === id);
                document.getElementById('s-modal-title').innerText = s.name;
                document.getElementById('s-modal-arabic').innerText = s.ar || '';
                document.getElementById('s-modal-count').innerText = (surahHistory[id] || []).length;
                openModal('surah-modal');
            }

            function modifySurahCount(delta) {
                if (!surahHistory[currentSurahId]) surahHistory[currentSurahId] = [];
                if (delta > 0) {
                    surahHistory[currentSurahId].push(Date.now());
                    showToast('+1 recitation recorded');
                    if (surahHistory[currentSurahId].length % 5 === 0) popConfetti();
                } else if (delta < 0 && surahHistory[currentSurahId].length > 0) {
                    surahHistory[currentSurahId].pop();
                }
                document.getElementById('s-modal-count').innerText = surahHistory[currentSurahId].length;
                saveAll(); renderSurahs(); updateDashboard();
            }

            function saveCustomSurah() {
                let name = document.getElementById('new-surah-name').value.trim();
                if (!name) { showToast('name required', 'error'); return; }
                let ar = document.getElementById('new-surah-ar').value.trim();
                let trans = document.getElementById('new-surah-trans').value.trim();
                customSurahs.push({ id: 'c_' + Date.now(), name, ar, trans });
                document.getElementById('new-surah-name').value = '';
                document.getElementById('new-surah-ar').value = '';
                document.getElementById('new-surah-trans').value = '';
                saveAll(); closeModal('add-surah-modal'); renderSurahs(); showToast('added');
            }

            // ---------- HISTORY MODAL (showing exact date/time) ----------
            function openHistory(type) {
                let container = document.getElementById('history-list-container');
                container.innerHTML = '';
                if (type === 'para') {
                    document.getElementById('h-modal-title').innerText = `Ruku timestamps ¬∑ Juz ${currentParaId}`;
                    let obj = progressData[currentParaId] || {};
                    let entries = Object.entries(obj).sort((a, b) => b[1] - a[1]);
                    if (!entries.length) container.innerHTML = '<div class="empty-history">No rukus recorded</div>';
                    else entries.forEach(([ruk, ts]) => {
                        container.innerHTML += `<div class="history-item"><span class="h-title">Ruku ${ruk}</span><span class="h-time">${formatTime(ts)}</span></div>`;
                    });
                } else {
                    let surah = getAllSurahs().find(s => s.id === currentSurahId);
                    document.getElementById('h-modal-title').innerText = `${surah?.name} history`;
                    let list = surahHistory[currentSurahId] || [];
                    let rev = [...list].reverse();
                    if (!rev.length) container.innerHTML = '<div class="empty-history">No readings yet</div>';
                    else rev.forEach((ts, idx) => {
                        container.innerHTML += `<div class="history-item"><span class="h-title">Reading #${rev.length - idx}</span><span class="h-time">${formatTime(ts)}</span></div>`;
                    });
                }
                openModal('history-modal');
            }

            // dashboard & progress ring
            function updateDashboard() {
                let totalRukus = 0, doneRukus = 0, completeParas = 0;
                defaultParaData.forEach(p => {
                    let t = getTotalRukus(p.id);
                    let obj = progressData[p.id] || {};
                    let d = Object.keys(obj).filter(k => parseInt(k) <= t).length;
                    totalRukus += t; doneRukus += d;
                    if (d >= t && t > 0) completeParas++;
                });
                let surahReads = Object.values(surahHistory).reduce((a, b) => a + b.length, 0);
                let percent = totalRukus ? Math.round((doneRukus / totalRukus) * 100) : 0;
                let circle = document.getElementById('progress-circle');
                let circumference = 2 * Math.PI * 36; // ~226
                let offset = circumference - (percent / 100) * circumference;
                circle.style.strokeDasharray = circumference;
                circle.style.strokeDashoffset = offset;
                document.getElementById('dash-paras').innerText = completeParas;
                document.getElementById('dash-percent').innerText = percent + '%';
                document.getElementById('dash-ruku-left').innerText = totalRukus - doneRukus;
                document.getElementById('dash-surah-total').innerText = surahReads;
            }

            // modals
            function openModal(id) { document.getElementById(id).classList.add('active'); }
            function closeModal(id, checkPara) {
                document.getElementById(id).classList.remove('active');
                if (checkPara && currentParaId) {
                    let t = getTotalRukus(currentParaId);
                    let d = Object.keys(progressData[currentParaId] || {}).filter(k => parseInt(k) <= t).length;
                    if (d >= t && t > 0) popConfetti();
                    renderParas(); updateDashboard();
                }
            }

            // clock
            function startClock() {
                function update() {
                    let n = new Date();
                    document.getElementById('sys-time').innerText = n.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('sys-date').innerText = n.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                    try {
                        let hij = new Intl.DateTimeFormat('en-US-u-ca-islamic-umalqura', { day: 'numeric', month: 'long', year: 'numeric' }).format(n);
                        document.getElementById('sys-hijri').innerText = hij;
                    } catch (e) { document.getElementById('sys-hijri').innerText = '--'; }
                }
                update(); setInterval(update, 10000);
            }

            // theme
            function toggleTheme() {
                let body = document.body;
                let theme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', theme);
                localStorage.setItem('qtp_theme', theme);
                document.getElementById('theme-icon').innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
            function applyTheme() {
                let theme = localStorage.getItem('qtp_theme') || 'light';
                document.body.setAttribute('data-theme', theme);
                document.getElementById('theme-icon').innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            // persist
            function saveAll() {
                localStorage.setItem('qtp_progress', JSON.stringify(progressData));
                localStorage.setItem('qtp_counts', JSON.stringify(customCounts));
                localStorage.setItem('qtp_surah_history', JSON.stringify(surahHistory));
                localStorage.setItem('qtp_custom_surahs', JSON.stringify(customSurahs));
            }

            // reset / export / import
            function resetAll() { if (confirm('erase all?')) { localStorage.clear(); location.reload(); } }
            function exportData() {
                let data = { progress: progressData, counts: customCounts, surahHistory, customSurahs, theme: document.body.getAttribute('data-theme') };
                let blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                let a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `QuranPro_${new Date().toISOString().slice(0, 10)}.json`;
                a.click(); showToast('backup saved');
            }
            function triggerImport() { document.getElementById('import-file').click(); }
            function importData(input) {
                let file = input.files[0];
                if (!file) return;
                let reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let data = JSON.parse(e.target.result);
                        if (data.progress) localStorage.setItem('qtp_progress', JSON.stringify(data.progress));
                        if (data.counts) localStorage.setItem('qtp_counts', JSON.stringify(data.counts));
                        if (data.surahHistory) localStorage.setItem('qtp_surah_history', JSON.stringify(data.surahHistory));
                        if (data.customSurahs) localStorage.setItem('qtp_custom_surahs', JSON.stringify(data.customSurahs));
                        if (data.theme) localStorage.setItem('qtp_theme', data.theme);
                        location.reload();
                    } catch { showToast('invalid file', 'error'); }
                };
                reader.readAsText(file);
            }

            // confetti
            function popConfetti() {
                let canvas = document.getElementById('confetti');
                let ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                let particles = [];
                for (let i = 0; i < 100; i++) particles.push({ x: canvas.width / 2, y: canvas.height / 2, vx: (Math.random() - 0.5) * 18, vy: (Math.random() - 0.5) * 18 - 10, size: Math.random() * 8 + 4, color: `hsl(${Math.random() * 70 + 160}, 80%, 60%)`, life: 1 });
                function anim() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let alive = false;
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.size *= 0.98; p.life -= 0.005;
                        if (p.life > 0.01) alive = true;
                        ctx.globalAlpha = p.life;
                        ctx.fillStyle = p.color;
                        ctx.fillRect(p.x - 4, p.y - 4, p.size, p.size);
                    });
                    if (alive) requestAnimationFrame(anim); else ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                anim();
            }

            // ---------- init ----------
            window.onload = function () {
                applyTheme();
                startClock();
                renderParas();
                renderSurahs();
                updateDashboard();
            };

            window.switchTab = switchTab;
            window.openParaModal = openParaModal;
            window.toggleRuku = toggleRuku;
            window.markAllRukus = markAllRukus;   // this was not added butt i add it now
            window.adjustTotal = adjustTotal;
            window.openModal = openModal;
            window.closeModal = closeModal;
            window.toggleTheme = toggleTheme;
            window.resetAll = resetAll;
            window.exportData = exportData;
            window.triggerImport = triggerImport;
            window.importData = importData;
            window.saveCustomSurah = saveCustomSurah;
            window.modifySurahCount = modifySurahCount;
            window.openHistory = openHistory;
            window.popConfetti = popConfetti;
            window.renderParas = renderParas; window.renderSurahs = renderSurahs; window.updateDashboard = updateDashboard; window.saveAll = saveAll;
        })();
    </script>
</body>

</html>
